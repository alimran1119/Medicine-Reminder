<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medicine Corner</title>
  <link rel="stylesheet" href="/styles.css" />
  <!-- REMOVE app.js from head -->
</head>
<body>
  <nav>
    <div class="container">
      <div class="brand">Medicine Reminder</div>
      <div class="links">
        <a class="link" href="/index.html">Login</a>
        <a class="link" href="/dashboard.html">Dashboard</a>
        <a id="adminLink" class="link hidden" href="/admin.html">Admin</a>
        <a class="link" href="/prescriptions.html">Prescription</a>
        <a class="link" href="/reminder.html">Reminder</a>
        <a class="link" href="/profile.html">Profile</a>
        <a class="link" href="/catalog.html">Medicine Corner</a>
        <a class="link" href="/cart.html">Cart</a>
      </div>
      <div class="spacer"></div>
      <a class="btn" href="/index.html" onclick="App.clearSession()">Logout</a>
    </div>
  </nav>

  <div class="container">
    <div class="card">
      <label for="search">Search by medicine name</label>
      <input id="search" placeholder="Type a name, e.g., paracetamol" />
    </div>

    <div class="card">
      <h2>Medicine Corner</h2>
      <div id="list" class="list"></div>

      <div class="mt-12" style="text-align:center;">
        <button id="prevBtn" disabled>« Prev</button>
        <span id="pageInfo" class="mx-4"></span>
        <button id="nextBtn" disabled>Next »</button>
      </div>

      <div class="mt-12">
        <button class="secondary" onclick="enablePush()">Enable Notifications</button>
        <span id="pushMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <footer>© Medicine Reminder</footer>

  <!-- Load shared app AFTER HTML, BEFORE page scripts -->
  <script src="/app.js"></script>
  <script src="/push.js"></script>

  <script>
    let ALL_ITEMS = [];
    let currentPage = 1;
    const pageSize = 15;
    let totalPages = 1;

    async function loadAll() {
      const list = document.getElementById('list');
      list.innerHTML = '<p class="muted">Loading…</p>';
      try {
        const res = await fetch('/api/catalog');
        ALL_ITEMS = await res.json();
        totalPages = Math.ceil(ALL_ITEMS.length / pageSize) || 1;
        renderPage(1);
      } catch (e) {
        list.innerHTML = '<p class="muted">Error loading items: ' + e.message + '</p>';
      }
    }

    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * pageSize;
      renderList(ALL_ITEMS.slice(start, start + pageSize));
      updatePager();
    }

    function renderList(items) {
      const list = document.getElementById('list');
      list.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <img src="${it.photoUrl || '/placeholder.png'}" alt="photo"/>
          <div class="title"></div>
          <div>৳ ${it.priceBdt}</div>
          <div class="mt-12">
            <button class="add-to-cart"
                    data-id="${it._id}"
                    data-name="${it.name.replace(/"/g,'&quot;')}"
                    data-price="${Number(it.priceBdt)||0}">
              Add to Cart
            </button>
            <button class="secondary buy-now"
                    data-id="${it._id}"
                    data-name="${it.name.replace(/"/g,'&quot;')}"
                    data-price="${Number(it.priceBdt)||0}">
              Buy
            </button>
          </div>`;
        div.querySelector('.title').textContent = it.name;
        list.appendChild(div);
      });
      if (items.length === 0) {
        list.innerHTML = '<p class="muted">No medicines found.</p>';
      }
    }

    function updatePager() {
      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('search').addEventListener('input', e => {
        const q = e.target.value.trim().toLowerCase();
        const filtered = q ? ALL_ITEMS.filter(it => it.name.toLowerCase().includes(q)) : ALL_ITEMS.slice();
        const list = document.getElementById('list');
        totalPages = Math.ceil(filtered.length / pageSize) || 1;
        const start = 0;
        renderList(filtered.slice(start, start + pageSize));
        document.getElementById('prevBtn').disabled = true;
        document.getElementById('nextBtn').disabled = totalPages <= 1;
        document.getElementById('pageInfo').textContent = `Page 1 of ${totalPages}`;
      });

      document.getElementById('prevBtn').onclick = () => currentPage > 1 && renderPage(currentPage - 1);
      document.getElementById('nextBtn').onclick = () => currentPage < totalPages && renderPage(currentPage + 1);

      window.enablePush = async () => {
        try { await askNotificationPermission(); document.getElementById('pushMsg').textContent = 'Notifications enabled ✔'; }
        catch (e) { document.getElementById('pushMsg').textContent = e.message; }
      };

      loadAll();
    });

    // ONE delegated handler only (handles Add and Buy)
    document.addEventListener('click', (e) => {
      const add = e.target.closest('.add-to-cart');
      if (add) {
        Cart.add({
          _id: add.dataset.id,
          name: add.dataset.name,
          priceBdt: Number(add.dataset.price) || 0,
          qty: 1
        });
        alert('Added to cart');
        return;
      }
      const buy = e.target.closest('.buy-now');
      if (buy) {
        Cart.add({
          _id: buy.dataset.id,
          name: buy.dataset.name,
          priceBdt: Number(buy.dataset.price) || 0,
          qty: 1
        });
        location.href = '/cart.html';
      }
    });
  </script>

  <script>
    if (typeof renderBottomNav === 'function') renderBottomNav();
  </script>
</body>
</html>
